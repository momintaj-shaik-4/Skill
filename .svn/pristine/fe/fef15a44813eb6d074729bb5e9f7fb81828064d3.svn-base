<div class="d-flex" style="height: 100vh;">
  <!-- Sidebar -->
  <nav class="bg-light border-end" style="width: 200px; padding: 1rem;">
    <ul class="nav flex-column">
      <li class="nav-item mb-2">
        <a class="nav-link active" href="#" [class.active]="mainNav === 'identifySkills'"
          (click)="selectNav('identifySkills'); $event.preventDefault()">Identify Skills & Expectations</a>
      </li>
      <li class="nav-item mb-2"  *ngIf="isManager()">
        <a class="nav-link" href="#" [class.active]="mainNav === 'Training Inventory'"
          (click)="selectNav('Training Inventory'); $event.preventDefault()">Training Inventory and Skill Level Mapping</a>
      </li>
      <li class="nav-item mb-2">
        <a class="nav-link" href="#" [class.active]="mainNav === 'Skill Assessment'"
          (click)="selectNav('Skill Assessment'); $event.preventDefault()">Engineer Skill Assessment and Target Setting</a>
      </li>
    </ul>
  </nav>

  <!-- Main content -->
  <div class="flex-fill d-flex flex-column position-relative">
    <!-- Header -->
    <header class="d-flex justify-content-between align-items-center bg-white border-bottom p-3">
      <h4 class="mb-0">Welcome, {{ currentUser?.employee_name }}</h4>
      <div>

        <button class="btn btn-outline-danger" (click)="logout()">Logout</button>
      </div>
    </header>
    <div class="content p-3">
      <div *ngIf="mainNav === 'identifySkills'">

        <!-- Content area scrolls -->
        <div class="flex-fill overflow-auto p-3 position-relative">
          <!-- My Record block -->
          <section class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5>My Record</h5>
              <button class="btn btn-outline-primary btn-sm" (click)="toggleMyFilters()">
                Filter
              </button>
            </div>
            <!-- My table -->
            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd;">
              <table class="table table-sm table-striped table-bordered mb-0">
                <thead class="table-light" style="position: sticky; top: 0; z-index: 10;">
                  <tr>
                    <th>Emp ID</th>
                    <th>Name</th>
                    <th>Division</th>
                    <th>Role Specific</th>
                    <th>Competency</th>
                    <th>Skill</th>
                    <th>Current Expertise</th>
                    <th>Target Expertise</th>
                  </tr>
                </thead>
                <tbody *ngIf="!loading">
                  <tr *ngFor="let row of filteredMyRows; trackBy: trackByFn"
                    [ngClass]="{ 'table-danger': rowHasMissingOrMismatch(row) }">
                    <td>{{ row.employee_empid }}</td>
                    <td>{{ row.employee_name }}</td>
                    <td>{{ row.division }}</td>
                    <td>{{ row.role_specific_comp }}</td>
                    <td>{{ row.competency }}</td>
                    <td>{{ row.skill }}</td>
                    <td>{{ row.current_expertise }}</td>
                    <td>{{ row.target_expertise }}</td>
                  </tr>
                  <tr *ngIf="filteredMyRows.length === 0">
                    <td colspan="7" class="text-center">No record found.</td>
                  </tr>
                </tbody>
                <tbody *ngIf="loading">
                  <tr>
                    <td colspan="8" class="text-center">Loading data...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <!-- Team Records (manager only) -->
          <section *ngIf="isManager()">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5>Team Records</h5>
              <button class="btn btn-outline-primary btn-sm" (click)="toggleTeamFilters()">
                Filter
              </button>
            </div>
            <div class="mb-2">
              <button class="btn btn-success me-2" (click)="addNew()" [disabled]="isSaving">
                Add New
              </button>
              <button class="btn btn-secondary me-2" (click)="saveAll()" [disabled]="isSaving || undoStack.length === 0"
                [ngClass]="(isSaving || undoStack.length === 0) ? 'btn-secondary' : 'btn-primary'">
                {{ isSaving ? 'Saving...' : 'Save All' }}
              </button>
              <button class="btn btn-secondary me-2" (click)="undo()" [disabled]="undoStack.length === 0"
                [ngClass]="undoStack.length === 0 ? 'btn-secondary' : 'btn-primary'">
                Undo
              </button>
              <button class="btn btn-secondary me-2" (click)="downloadExcel()" [disabled]="isExporting"
                [ngClass]="(isExporting) ? 'btn-secondary' : 'btn-primary'">
                {{ isExporting ? 'exporting...' : 'Export' }}
              </button>
            </div>
            <div class="loading-overlay" *ngIf="isSaving">
              <div class="spinner-border text-primary" role="status" aria-label="Saving...">
                <span class="visually-hidden">Saving...</span>
              </div>
            </div>
            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd;">
              <table class="table table-sm table-striped table-bordered mb-0">
                <thead class="table-light" style="position: sticky; top: 0; z-index: 10;">
                  <tr>
                    <th style="width: 60px;">Actions</th>
                    <th>Emp ID</th>
                    <th>Name</th>
                    <th>Division</th>
                    <th>Role Specific</th>
                    <th>Competency</th>
                    <th>Skill</th>
                    <th>Current Expertise</th>
                    <th>Target Expertise</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let row of filteredTeamRows; let rowIndex = index; trackBy: trackByFn"
                    [ngClass]="{ 'table-danger': rowHasMissingOrMismatch(row) }">
                    <td class="text-center align-middle">
                      <button class="btn btn-sm btn-outline-danger" (click)="removeTeamRow(row,rowIndex)"
                        [disabled]="isSaving" title="Remove this row">
                        &times;
                      </button>
                    </td>
                    <td>
                      <!-- If new row: show dropdown -->
                      <select *ngIf="row.isNew" class="form-control form-control-sm" [(ngModel)]="row.employee_empid"
                        [disabled]="isSaving" (focus)="saveRowSnapshot(row)"
                        (ngModelChange)="onFieldChange(row, 'employee_empid', $event)" (blur)="onEditComplete()">
                        <option [ngValue]="null" disabled>Select Employee ID</option>
                        <option *ngFor="let empId of getUniqueEmployeeIdsInRows()" [ngValue]="empId">
                          {{ empId }}
                        </option>
                      </select>

                      <!-- If existing row: show readonly input -->
                      <input *ngIf="!row.isNew" type="number" class="form-control form-control-sm"
                        [value]="row.employee_empid" readonly
                        (ngModelChange)="onFieldChange(row, 'employee_empid', $event)" (blur)="onEditComplete()" />
                    </td>
                    <td>
                      <input type=" text" class="form-control form-control-sm" [(ngModel)]="row.employee_name"
                        (focus)="saveRowSnapshot(row)" (ngModelChange)="onFieldChange(row, 'employee_name', $event)"
                        (blur)="onEditComplete()" readonly />
                    </td>
                    <td>
                      <input type="text" class="form-control form-control-sm" [(ngModel)]="row.division"
                        (focus)="saveRowSnapshot(row)" (ngModelChange)="onFieldChange(row, 'division', $event)"
                        (blur)="onEditComplete()" />
                    </td>
                    <td>
                      <input type="text" class="form-control form-control-sm" [(ngModel)]="row.role_specific_comp"
                        (focus)="saveRowSnapshot(row)"
                        (ngModelChange)="onFieldChange(row, 'role_specific_comp', $event)" (blur)="onEditComplete()" />
                    </td>
                    <td>
                      <input type="text" class="form-control form-control-sm" [(ngModel)]="row.competency"
                        (focus)="saveRowSnapshot(row)" (ngModelChange)="onFieldChange(row, 'competency', $event)"
                        (blur)="onEditComplete()" />
                    </td>
                    <td>
                      <input type="text" class="form-control form-control-sm" [(ngModel)]="row.skill"
                        (focus)="saveRowSnapshot(row)" (ngModelChange)="onFieldChange(row, 'skill', $event)"
                        (blur)="onEditComplete()" />
                    </td>
                    <td>
                      <input type="text" class="form-control form-control-sm" [(ngModel)]="row.current_expertise"
                        (focus)="saveRowSnapshot(row)" (ngModelChange)="onFieldChange(row, 'current_expertise', $event)"
                        (blur)="onEditComplete()" />
                    </td>
                    <td>
                      <input type="text" class="form-control form-control-sm" [(ngModel)]="row.target_expertise"
                        (focus)="saveRowSnapshot(row)" (ngModelChange)="onFieldChange(row, 'target_expertise', $event)"
                        (blur)="onEditComplete()" />
                    </td>

                  </tr>
                  <tr *ngIf="filteredTeamRows.length === 0">
                    <td colspan="8" class="text-center">No team records found.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <!-- My Filter Panel -->
          <div *ngIf="showMyFilters" class="position-absolute top-0 end-0 bg-white border shadow"
            style="width: 280px; height: 100%; overflow-y: auto; z-index: 1000;">
            <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
              <strong>My Record Filters</strong>
              <button class="btn btn-sm btn-outline-secondary" (click)="toggleMyFilters()">×</button>
            </div>
            <div class="p-2">
              <div *ngIf="filterDivisions.length > 1" class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <label class="form-label fw-bold mb-0">Division</label>
                  <button class="btn btn-sm btn-link p-0" (click)="selectAllMyDivisions()">All</button>
                  <button class="btn btn-sm btn-link p-0" (click)="clearAllMyDivisions()">Clear</button>
                </div>
                <div style="max-height: 100px; overflow-y: auto;">
                  <div *ngFor="let division of filterDivisions">
                    <input type="checkbox" [checked]="selDivisions.includes(division)"
                      (change)="onDivisionCheckboxChange($event, division)" id="division-{{division}}" />
                    <label for="division-{{division}}">{{ division }}</label>
                  </div>

                </div>
              </div>
              <div *ngIf="filterRoleSpec.length > 1" class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <label class="form-label fw-bold mb-0">Role Specific</label>
                  <button class="btn btn-sm btn-link p-0" (click)="selectAllMyRoleSpec()">All</button>
                  <button class="btn btn-sm btn-link p-0" (click)="clearAllMyRoleSpec()">Clear</button>
                </div>
                <div style="max-height: 100px; overflow-y: auto;">
                  <div *ngFor="let rs of filterRoleSpec">
                    <input type="checkbox" [checked]="selRoleSpec.includes(rs)"
                      (change)="onRoleSpecCheckboxChange($event, rs)" id="rs-{{rs}}" />
                    <label for="rs-{{rs}}">{{ rs }}</label>
                  </div>
                </div>
              </div>
              <div *ngIf="filterCompetencies.length > 1" class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <label class="form-label fw-bold mb-0">Competency</label>
                  <button class="btn btn-sm btn-link p-0" (click)="selectAllMyCompetencies()">All</button>
                  <button class="btn btn-sm btn-link p-0" (click)="clearAllMyCompetencies()">Clear</button>
                </div>
                <div style="max-height: 100px; overflow-y: auto;">
                  <div *ngFor="let competency of filterCompetencies">
                    <input type="checkbox" [checked]="selCompetencies.includes(competency)"
                      (change)="onCompetencyCheckboxChange($event, competency)" id="competency-{{competency}}" />
                    <label for="competency-{{competency}}">{{ competency }}</label>
                  </div>
                </div>
              </div>
              <div *ngIf="filterSkills.length > 1" class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <label class="form-label fw-bold mb-0">Skill</label>
                  <button class="btn btn-sm btn-link p-0" (click)="selectAllMySkills()">All</button>
                  <button class="btn btn-sm btn-link p-0" (click)="clearAllMySkills()">Clear</button>
                </div>
                <div style="max-height: 100px; overflow-y: auto;">
                  <div *ngFor="let skill of filterSkills">
                    <input type="checkbox" [value]="skill" [checked]="selSkills.includes(skill)"
                      (change)="onMySkillCheckboxChange($event, skill)" id="skill-{{skill}}" />
                    <label for="skill-{{skill}}">{{ skill }}</label>
                  </div>
                </div>
              </div>
              <div *ngIf="filterCurrentExpertise.length > 1" class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <label class="form-label fw-bold mb-0">Current Expertise</label>
                  <button class="btn btn-sm btn-link p-0" (click)="selectAllMyCurrentExpertise()">All</button>
                  <button class="btn btn-sm btn-link p-0" (click)="clearAllMyCurrentExpertise()">Clear</button>
                </div>
                <div style="max-height: 100px; overflow-y: auto;">
                  <div *ngFor="let ex of filterCurrentExpertise">
                    <input type="checkbox" [value]="ex" [checked]="selCurrentExpertise.includes(ex)"
                      (change)="onMyCurrentExCheckboxChange($event, ex)" id="ex-{{ex}}" />
                    <label for="ex-{{ex}}">{{ ex }}</label>
                  </div>
                </div>
              </div>
              <div *ngIf="filterTargetExpertise.length > 1" class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <label class="form-label fw-bold mb-0">Target Expertise</label>
                  <button class="btn btn-sm btn-link p-0" (click)="selectAllMyTargetExpertise()">All</button>
                  <button class="btn btn-sm btn-link p-0" (click)="clearAllMyTargetExpertise()">Clear</button>
                </div>
                <div style="max-height: 100px; overflow-y: auto;">
                  <div *ngFor="let ex of filterTargetExpertise">
                    <input type="checkbox" [value]="ex" [checked]="selTargetExpertise.includes(ex)"
                      (change)="onMyTargetExCheckboxChange($event, ex)" id="ex-{{ex}}" />
                    <label for="ex-{{ex}}">{{ ex }}</label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Team Filter Panel -->
          <div *ngIf="showTeamFilters" class="position-absolute top-0 end-0 bg-white border shadow"
            style="width: 280px; height: 100%; overflow-y: auto; z-index: 1000;">
            <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
              <strong>Team Filters</strong>
              <button class="btn btn-sm btn-outline-secondary" (click)="toggleTeamFilters()">×</button>
            </div>
            <div class="p-2">
              <!-- Employee ID -->
              <div *ngIf="teamFilterEmpIds.length > 1" class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <label class="form-label fw-bold mb-0">Employee ID</label>
                  <button class="btn btn-sm btn-link p-0" (click)="selectAllTeamEmpIds()">All</button>
                  <button class="btn btn-sm btn-link p-0" (click)="clearAllTeamEmpIds()">Clear</button>
                </div>
                <div style="max-height: 100px; overflow-y: auto;">
                  <div *ngFor="let empId of teamFilterEmpIds">
                    <input type="checkbox" [checked]="teamSelEmpIds.includes(empId)"
                      (change)="onEmpIdCheckboxChange($event, empId.toString())" id="team-empid-{{empId}}" />
                    <label for="team-empid-{{empId}}">{{ empId }}</label>
                  </div>
                </div>
              </div>

              <!-- Employee Name -->
              <div *ngIf="teamFilterNames.length > 1" class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <label class="form-label fw-bold mb-0">Employee Name</label>
                  <button class="btn btn-sm btn-link p-0" (click)="selectAllTeamNames()">All</button>
                  <button class="btn btn-sm btn-link p-0" (click)="clearAllTeamNames()">Clear</button>
                </div>
                <div style="max-height: 100px; overflow-y: auto;">
                  <div *ngFor="let empName of teamFilterNames">
                    <input type="checkbox" [checked]="teamSelNames.includes(empName)"
                      (change)="onEmpNameCheckboxChange($event, empName)" id="team-name-{{empName}}" />
                    <label for="team-name-{{empName}}">{{ empName }}</label>
                  </div>
                </div>
              </div>
              <!-- Division -->
              <div *ngIf="teamFilterDivisions.length > 1" class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <label class="form-label fw-bold mb-0">Division</label>
                  <button class="btn btn-sm btn-link p-0" (click)="selectAllTeamDivisions()">All</button>
                  <button class="btn btn-sm btn-link p-0" (click)="clearAllTeamDivisions()">Clear</button>
                </div>
                <div style="max-height: 100px; overflow-y: auto;">
                  <div *ngFor="let dv of teamFilterDivisions">
                    <input type="checkbox" [checked]="teamSelDivisions.includes(dv)"
                      (change)="onTeamDivisionCheckboxChange($event, dv)" id="team-division-{{dv}}" />
                    <label for="team-division-{{dv}}">{{ dv }}</label>
                  </div>
                </div>
              </div>

              <!-- Role Specific -->
              <div *ngIf="teamFilterRoleSpec.length > 1" class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <label class="form-label fw-bold mb-0">Role Specific</label>
                  <button class="btn btn-sm btn-link p-0" (click)="selectAllTeamRoleSpec()">All</button>
                  <button class="btn btn-sm btn-link p-0" (click)="clearAllTeamRoleSpec()">Clear</button>
                </div>
                <div style="max-height: 100px; overflow-y: auto;">
                  <div *ngFor="let rs of teamFilterRoleSpec">
                    <input type="checkbox" [checked]="teamSelRoleSpec.includes(rs)"
                      (change)="onTeamRoleSpecCheckboxChange($event, rs)" id="team-role-{{rs}}" />
                    <label for="team-role-{{rs}}">{{ rs }}</label>
                  </div>
                </div>
              </div>

              <!-- Competency -->
              <div *ngIf="teamFilterCompetencies.length > 1" class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <label class="form-label fw-bold mb-0">Competency</label>
                  <button class="btn btn-sm btn-link p-0" (click)="selectAllTeamCompetencies()">All</button>
                  <button class="btn btn-sm btn-link p-0" (click)="clearAllTeamCompetencies()">Clear</button>
                </div>
                <div style="max-height: 100px; overflow-y: auto;">
                  <div *ngFor="let cp of teamFilterCompetencies">
                    <input type="checkbox" [checked]="teamSelCompetencies.includes(cp)"
                      (change)="onTeamCompetencyCheckboxChange($event, cp)" id="team-competency-{{cp}}" />
                    <label for="team-competency-{{cp}}">{{ cp }}</label>
                  </div>
                </div>
              </div>

              <!-- Skill -->
              <div *ngIf="teamFilterSkills.length > 1" class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <label class="form-label fw-bold mb-0">Skill</label>
                  <button class="btn btn-sm btn-link p-0" (click)="selectAllTeamSkills()">All</button>
                  <button class="btn btn-sm btn-link p-0" (click)="clearAllTeamSkills()">Clear</button>
                </div>
                <div style="max-height: 100px; overflow-y: auto;">
                  <div *ngFor="let sk of teamFilterSkills">
                    <input type="checkbox" [checked]="teamSelSkills.includes(sk)"
                      (change)="onTeamSkillCheckboxChange($event, sk)" id="team-skill-{{sk}}" />
                    <label for="team-skill-{{sk}}">{{ sk }}</label>
                  </div>
                </div>
              </div>

              <!-- Expertise -->
              <div *ngIf="teamFilterCurrentExpertise.length > 1" class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <label class="form-label fw-bold mb-0">Current Expertise</label>
                  <button class="btn btn-sm btn-link p-0" (click)="selectAllTeamCurrentExpertise()">All</button>
                  <button class="btn btn-sm btn-link p-0" (click)="clearAllTeamCurrentExpertise()">Clear</button>
                </div>

                <div style="max-height: 100px; overflow-y: auto;">
                  <div *ngFor="let ex of teamFilterCurrentExpertise">
                    <input type="checkbox" [checked]="teamSelCurrentExpertise.includes(ex)"
                      (change)="onTeamCurrentExpertiseCheckboxChange($event, ex)" id="team-expertise-{{ex}}" />
                    <label for="team-expertise-{{ex}}">{{ ex }}</label>
                  </div>
                </div>
              </div>

              <div *ngIf="teamFilterTargetExpertise.length > 1" class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <label class="form-label fw-bold mb-0">Target Expertise</label>
                  <button class="btn btn-sm btn-link p-0" (click)="selectAllTeamTargetExpertise()">All</button>
                  <button class="btn btn-sm btn-link p-0" (click)="clearAllTeamTargetExpertise()">Clear</button>
                </div>

                <div style="max-height: 100px; overflow-y: auto;">
                  <div *ngFor="let ex of teamFilterTargetExpertise">
                    <input type="checkbox" [checked]="teamSelTargetExpertise.includes(ex)"
                      (change)="onTeamTargetExpertiseCheckboxChange($event, ex)" id="team-expertise-{{ex}}" />
                    <label for="team-expertise-{{ex}}">{{ ex }}</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- End Filter Panels -->
        </div>
        </div>
        <div *ngIf="mainNav === 'Training Inventory'">
          <p>Content for Tab 2 goes here.</p>
        </div>

        <div *ngIf="mainNav === 'Skill Assessment'">
          <p>Content for Tab 3 goes here.</p>
        </div>
      </div>
    </div>
